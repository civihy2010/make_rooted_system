#!/system/bin/sh

tmp_dir=/data/local/tmp/su_update_tmp
tmp_apk=$tmp_dir/supersu.apk

apk_su=assets/supersu.arm.png
curr_su_deamon=/system/xbin/daemonsu
curr_su=/system/xbin/su

cleanup()
{
	rm -rf $tmp_dir
	exit $1	
}

system_mount()
{
	_type=$1
	/system/etc/su_client -c "/system/etc/busybox_file mount -o remount,$1 /system"
}

get_install_apk()
{
	apk_name=`/system/etc/su_client -c \\\"ls /data/app/ | grep eu.chainfire.supersu\\\"`
	if [ ! -z "$apk_name" ] ;then
	
		mkdir $tmp_dir
	
		/system/etc/su_client -c "cp /data/app/$apk_name $tmp_apk && chmod 666 $tmp_apk"
		if [ -f "$tmp_apk" ] ;then
			echo $apk_name detect
		else
			echo supersu not installed
			cleanup 1
		fi
	else
		echo supersu not installed
	fi
}

get_apk_su()
{
	cd $tmp_dir
	/system/etc/busybox_file unzip -q $tmp_apk $apk_su -d $tmp_dir
	chmod 755 $tmp_dir/$apk_su
}

check_update()
{
	tmp_ver=`$tmp_dir/$apk_su -V`
	cur_ver=`$curr_su_deamon -V`
	echo tmp_ver: $tmp_ver
	echo cur_ver: $cur_ver
	if [ $tmp_ver -gt $cur_ver ] ;then
		echo DETECT UPDATE SuperSU!!!
	else
		cleanup 1
	fi
}

replace_su_binary()
{
	system_mount rw
	/system/etc/su_client -c "cp $tmp_dir/$apk_su $curr_su_deamon"
	/system/etc/su_client -c "chmod 755 $curr_su_deamon"
	/system/etc/su_client -c "cp $tmp_dir/$apk_su $curr_su_deamon"
	/system/etc/su_client -c "chmod 755 $curr_su_deamon"
	/system/etc/su_client -c "cp $curr_su_deamon /system/bin/.ext/.su"
	system_mount ro
	echo new su binary installed
}

get_install_apk
get_apk_su
check_update && replace_su_binary
cleanup
